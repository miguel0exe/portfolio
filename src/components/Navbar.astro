---
import { Icon } from "astro-icon/components";

const navItems = [
  {
    title: "Inicio",
    label: "inicio",
    url: "/#", // Truco: Apunta a top
    icon: "mdi:home-outline",
  },
  {
    title: "Misiones",
    label: "experiencia",
    url: "/#experiencia",
    icon: "mdi:scroll-text-outline",
  },
  // {
  //   title: "Grimorio",
  //   label: "proyectos",
  //   url: "/#proyectos",
  //   icon: "mdi:book-open-page-variant-outline",
  // },
  {
    title: "Personaje",
    label: "sobre-mi",
    url: "/#sobre-mi",
    icon: "mdi:account-box-outline",
  },
  {
    title: "Grimorio",
    label: "grimorio",
    url: "/grimorio",
    icon: "mdi:creation",
  },
  {
    title: "Invocar",
    label: "footer",
    url: "mailto:miguel.emezero@gmail.com",
    icon: "mdi:email-outline",
  },
];
---

<nav class="fixed top-6 left-1/2 -translate-x-1/2 z-50 hidden md:block">
  <div
    class="relative flex items-center gap-8 px-8 py-3 bg-[#0c0a09]/90 backdrop-blur-md border-y-2 border-[#C8AA6E]/40 rounded-full shadow-[0_10px_30px_rgba(0,0,0,0.8)] clip-path-hud"
  >
    <div
      class="absolute left-2 top-1/2 -translate-y-1/2 w-2 h-2 bg-[#C8AA6E] rotate-45 shadow-[0_0_10px_#C8AA6E]"
    >
    </div>
    <div
      class="absolute right-2 top-1/2 -translate-y-1/2 w-2 h-2 bg-[#C8AA6E] rotate-45 shadow-[0_0_10px_#C8AA6E]"
    >
    </div>

    {
      navItems.map((link) => (
        <a
          href={link.url}
          aria-label={link.label}
          class="nav-link relative group flex flex-col items-center justify-center"
          data-section={link.label}
        >
          <span class="font-cinzel text-sm font-bold text-[#78716c] tracking-widest group-hover:text-[#C8AA6E] transition-colors duration-300">
            {link.title}
          </span>
          <span class="absolute -bottom-2 w-1 h-1 bg-[#C8AA6E] rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300 shadow-[0_0_8px_#C8AA6E]" />
        </a>
      ))
    }
  </div>
</nav>

<nav
  class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 md:hidden w-[90%] max-w-sm"
>
  <div
    class="flex justify-between items-center bg-[#1c1917]/95 border border-[#44403c] rounded-lg p-2 shadow-2xl relative overflow-hidden"
  >
    <div
      class="absolute top-0 left-0 right-0 h-[1px] bg-gradient-to-r from-transparent via-[#C8AA6E]/50 to-transparent"
    >
    </div>
    {
      navItems.map((link) => (
        <a
          href={link.url}
          aria-label={link.label}
          class="nav-link-mobile relative p-3 rounded border border-transparent hover:border-[#C8AA6E]/30 hover:bg-[#C8AA6E]/10 transition-all active:scale-95 group"
        >
          <Icon
            name={link.icon}
            class="w-6 h-6 text-[#a8a29e] group-hover:text-[#C8AA6E] transition-colors"
          />
          <span class="absolute -top-10 left-1/2 -translate-x-1/2 bg-[#0c0a09] border border-[#C8AA6E] text-[#C8AA6E] text-[10px] uppercase tracking-widest px-2 py-1 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">
            {link.title}
          </span>
        </a>
      ))
    }
  </div>
</nav>

<script>
  /* LÓGICA HÍBRIDA: RUTA ACTUAL + SCROLL SPY */
  const sections = document.querySelectorAll("section, footer");
  const navLinksDesktop = document.querySelectorAll(".nav-link");
  const navLinksMobile = document.querySelectorAll(".nav-link-mobile");

  // Función para activar un link visualmente
  function activateLink(label) {
    // 1. Limpiar todo primero
    navLinksDesktop.forEach((link) => {
      link
        .querySelector("span")
        ?.classList.remove("text-[#C8AA6E]", "text-shadow-glow");
      link.querySelector("span")?.classList.add("text-[#78716c]");
      link.querySelector("span:last-child")?.classList.remove("opacity-100");
    });
    navLinksMobile.forEach((link) => {
      link.classList.remove("bg-[#C8AA6E]/10", "border-[#C8AA6E]/30");
      link.querySelector("svg")?.classList.remove("text-[#C8AA6E]");
    });

    // 2. Activar el correcto (Desktop)
    const activeDesktop = document.querySelector(
      `.nav-link[aria-label="${label}"]`,
    );
    if (activeDesktop) {
      activeDesktop.querySelector("span")?.classList.remove("text-[#78716c]");
      activeDesktop
        .querySelector("span")
        ?.classList.add("text-[#C8AA6E]", "text-shadow-glow");
      activeDesktop
        .querySelector("span:last-child")
        ?.classList.add("opacity-100");
    }

    // 3. Activar el correcto (Mobile)
    const activeMobile = document.querySelector(
      `.nav-link-mobile[aria-label="${label}"]`,
    );
    if (activeMobile) {
      activeMobile.classList.add("bg-[#C8AA6E]/10", "border-[#C8AA6E]/30");
      activeMobile.querySelector("svg")?.classList.add("text-[#C8AA6E]");
    }
  }

  // --- ESCENARIO 1: RUTAS ESTÁTICAS (GRIMORIO) ---
  const currentPath = window.location.pathname;

  if (currentPath.includes("/grimorio")) {
    activateLink("grimorio");
  }
  // --- ESCENARIO 2: HOMEPAGE CON SCROLL ---
  else {
    // Si estamos en home, iniciamos el observer
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            let label = "";
            const id = entry.target.id;

            // Mapeo de ID de sección -> Label del Nav
            if (id === "experiencia") label = "experiencia";
            if (id === "proyectos") label = "proyectos";
            if (id === "sobre-mi") label = "sobre-mi";
            if (entry.target.tagName === "FOOTER") label = "footer";

            // Caso especial: El Hero (Inicio) no tiene ID a veces, o es la primera sección
            // Asumimos que si no es ninguna de las anteriores y es una section visible arriba, es inicio
            if (!label && id === "") label = "inicio";
            if (label) activateLink(label);
          }
        });
      },
      {
        threshold: 0.3, // Un poco más sensible (30%)
        rootMargin: "-10% 0px -50% 0px",
      },
    );

    // Solo observamos secciones si estamos en la home
    sections.forEach((s) => observer.observe(s));

    // Check inicial: Si estamos arriba del todo (window.scrollY === 0), activar Inicio
    window.addEventListener("scroll", () => {
      if (window.scrollY < 100) activateLink("inicio");
    });
    // Activar inicio al cargar si estamos arriba
    if (window.scrollY < 100) activateLink("inicio");
  }
</script>

<style>
  .text-shadow-glow {
    text-shadow: 0 0 10px rgba(200, 170, 110, 0.6);
  }
</style>
